SELECT churn, COUNT(*) FROM customer GROUP BY churn;

-- Overall churn rate, shows the total churn rate is around 27%
SELECT 
    COUNT(*) AS total_customers,
    SUM(CASE WHEN Churn = 'Yes' THEN 1 ELSE 0 END) AS churned_customers,
    ROUND(SUM(CASE WHEN Churn = 'Yes' THEN 1 ELSE 0 END) * 100.0/COUNT(*),2) AS churn_rate
FROM customer;

-- Churn rate by gender, shows churn rate is about the same for each gender, so no gender-specific insights
SELECT 
	gender, 
	count(*), 
	round(SUM(case when churn = 'Yes' then 1 else 0 end),2) as churned_total, 
	round(1.0 * sum(case when churn = 'Yes' then 1 else 0 end) / count(*),2) as churn_rate  
FROM customer group by gender;

-- Tenure Analysis, shows customers with overall more tenure are less likely to churn out
SELECT 
	CASE WHEN tenure < 10 THEN '<10'
	WHEN tenure > 10 AND tenure < 30 THEN '10-30'
	WHEN tenure > 30 AND tenure < 50 THEN '30-50'
	ELSE '>50'
	END AS tenure_group,
	count(*) AS total,
	SUM(CASE WHEN churn  = 'Yes' THEN 1 ELSE 0 END) AS churned, 
	ROUND(SUM(CASE WHEN churn  = 'Yes' THEN 1 ELSE 0 END) * 1.0 / count(*),2) AS churned_rate
FROM customer
GROUP BY tenure_group
ORDER BY tenure_group ASC;

-- Churn by contract type, shows customers on shorter contracts are more likely to churn
SELECT 
	contract, 
	COUNT(*) as total, 
	SUM(CASE WHEN churn = 'Yes' THEN 1 ELSE 0 END) as churned_total, 
	round(SUM(CASE WHEN churn = 'Yes' THEN 1 ELSE 0 END) *1.0 / COUNT(*),2) as churned_rate  
FROM customer GROUP BY contract ORDER BY churned_rate DESC;

-- -- Customers with paperless billing are more than 2X likely to churn compared to those without

SELECT 
	paperlessbilling, 
	COUNT(*) as total,
	SUM(CASE WHEN churn = 'Yes' THEN 1 ELSE 0 END) as churned_total,
	ROUND(SUM(CASE WHEN churn = 'Yes' THEN 1 ELSE 0 END) *1.0 / COUNT(*),2) as churned_rate  
FROM customer GROUP BY paperlessbilling;


-- Internet Service, Customers with Fibre Optic are more likely to churn instead of those who have DSL or no internet
SELECT 
	internetservice, 
	COUNT(*) as total,
	SUM(CASE WHEN churn = 'Yes' THEN 1 ELSE 0 END) as churned_total,
	ROUND(SUM(CASE WHEN churn = 'Yes' THEN 1 ELSE 0 END) *1.0 / COUNT(*),2) as churned_rate  
FROM customer GROUP BY internetservice;

-- Average monthly charges of churned vs non-churned customers, shows customers likely to churn have more monthly charges
SELECT churn, ROUND(AVG(monthlycharges),2) FROM customer GROUP BY churn;

-- Customers with electronic check are more likely to churn compared to mailed check or bank transfer, least rate is for those who use credit card
SELECT 
	paymentmethod, 
	COUNT(*) as total,
	SUM(CASE WHEN churn = 'Yes' THEN 1 ELSE 0 END) as churned_total,
	ROUND(SUM(CASE WHEN churn = 'Yes' THEN 1 ELSE 0 END) *1.0 / COUNT(*),2) as churned_rate  
FROM customer GROUP BY paymentmethod ORDER BY churned_rate DESC;


-- Having multiple services (phone + internet + streaming) does not reduce churn, instead customers with one service have the lowest churn rate

WITH sub AS
(
    SELECT 
        customerID,
        (CASE WHEN PhoneService = 'Yes' THEN 1 ELSE 0 END +
         CASE WHEN InternetService IN ('DSL','Fiber optic') THEN 1 ELSE 0 END +
         CASE WHEN StreamingTV = 'Yes' THEN 1 ELSE 0 END +
         CASE WHEN StreamingMovies = 'Yes' THEN 1 ELSE 0 END) AS service_count,
        Churn
    FROM customer
) 
SELECT 
    service_count,
    COUNT(*) AS total_customers,
    SUM(CASE WHEN Churn = 'Yes' THEN 1 ELSE 0 END) AS churned_customers,
    ROUND(SUM(CASE WHEN Churn = 'Yes' THEN 1 ELSE 0 END)*1.0 / COUNT(*), 2) AS churn_rate
FROM sub
GROUP BY service_count
ORDER BY service_count ASC;


-- Churn rate among customers who use online security and online backup varies, while customers having none of them have the most churn rate
SELECT 
	onlinesecurity, onlinebackup,
	SUM(CASE WHEN churn = 'Yes' THEN 1 ELSE 0 END) AS churned_total,
	ROUND(SUM(CASE WHEN churn = 'Yes' THEN 1 ELSE 0 END) * 1.0 / COUNT(*),2) as churn_rate
FROM customer GROUP BY onlinesecurity, onlinebackup;

-- Revenue loss due to churn is significant, with average loss is around 75

SELECT 
    ROUND(SUM(MonthlyCharges),2) AS total_revenue_loss,
    ROUND(AVG(MonthlyCharges),2) AS avg_revenue_loss_per_customer
FROM customer
WHERE Churn = 'Yes';
















